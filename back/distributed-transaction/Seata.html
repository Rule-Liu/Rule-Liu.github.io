<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>分布式事务解决框架 Seata + SpringCloud + Nacos | RuleLau&#39;s Blog</title>
    <meta name="generator" content="VuePress 1.7.1">
    <link rel="icon" href="/icon.jpg">
    <meta name="description" content="我的个人网站">
    
    <link rel="preload" href="/assets/css/0.styles.99ba71c7.css" as="style"><link rel="preload" href="/assets/js/app.eb78e4ff.js" as="script"><link rel="preload" href="/assets/js/2.062734e7.js" as="script"><link rel="preload" href="/assets/js/17.0fce2c50.js" as="script"><link rel="prefetch" href="/assets/js/10.1fa9c2ce.js"><link rel="prefetch" href="/assets/js/11.b67db8c9.js"><link rel="prefetch" href="/assets/js/12.41340d35.js"><link rel="prefetch" href="/assets/js/13.f7873189.js"><link rel="prefetch" href="/assets/js/14.3a7cc814.js"><link rel="prefetch" href="/assets/js/15.7c3e8bd4.js"><link rel="prefetch" href="/assets/js/16.4d3c2513.js"><link rel="prefetch" href="/assets/js/18.0fee2fc2.js"><link rel="prefetch" href="/assets/js/19.cd739ab0.js"><link rel="prefetch" href="/assets/js/20.ccee1235.js"><link rel="prefetch" href="/assets/js/21.3b3ad479.js"><link rel="prefetch" href="/assets/js/22.1a0c7439.js"><link rel="prefetch" href="/assets/js/23.e1875da8.js"><link rel="prefetch" href="/assets/js/24.5428519d.js"><link rel="prefetch" href="/assets/js/25.4be82a8e.js"><link rel="prefetch" href="/assets/js/26.ee5c4ae0.js"><link rel="prefetch" href="/assets/js/27.6f1bb712.js"><link rel="prefetch" href="/assets/js/28.668b830a.js"><link rel="prefetch" href="/assets/js/29.e001ee62.js"><link rel="prefetch" href="/assets/js/3.7c25579e.js"><link rel="prefetch" href="/assets/js/30.14b54e61.js"><link rel="prefetch" href="/assets/js/31.8c7b7656.js"><link rel="prefetch" href="/assets/js/32.7895a749.js"><link rel="prefetch" href="/assets/js/33.7fdc13eb.js"><link rel="prefetch" href="/assets/js/34.497597fd.js"><link rel="prefetch" href="/assets/js/35.e45ce9de.js"><link rel="prefetch" href="/assets/js/36.dff9db21.js"><link rel="prefetch" href="/assets/js/37.84dca43f.js"><link rel="prefetch" href="/assets/js/38.d35b0106.js"><link rel="prefetch" href="/assets/js/39.cdb3310a.js"><link rel="prefetch" href="/assets/js/4.23425003.js"><link rel="prefetch" href="/assets/js/40.09ef43de.js"><link rel="prefetch" href="/assets/js/41.611a6d59.js"><link rel="prefetch" href="/assets/js/42.67cf3e85.js"><link rel="prefetch" href="/assets/js/43.6327f0de.js"><link rel="prefetch" href="/assets/js/5.cb6c276b.js"><link rel="prefetch" href="/assets/js/6.8acca1fd.js"><link rel="prefetch" href="/assets/js/7.fca05378.js"><link rel="prefetch" href="/assets/js/8.1f37df4a.js"><link rel="prefetch" href="/assets/js/9.f5dc1ff5.js">
    <link rel="stylesheet" href="/assets/css/0.styles.99ba71c7.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/icon.jpg" alt="RuleLau's Blog" class="logo"> <span class="site-name can-hide">RuleLau's Blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/back/" class="nav-link router-link-active">
  后端
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/back/" class="nav-link router-link-active">
  后端
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JVM</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Concurrency</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>ThreadPool</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Redis</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>SpringCloud</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Design Pattern</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Distributed-Transaction</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/back/distributed-transaction/Transaction.html" class="sidebar-link">分布式事务原理及解决方案</a></li><li><a href="/back/distributed-transaction/Seata.html" aria-current="page" class="active sidebar-link">分布式事务解决框架 Seata + SpringCloud + Nacos</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/back/distributed-transaction/Seata.html#一、搭建-seata-nacos" class="sidebar-link">一、搭建 Seata + Nacos</a></li><li class="sidebar-sub-header"><a href="/back/distributed-transaction/Seata.html#spring-cloud-集成-seata" class="sidebar-link">Spring Cloud 集成 Seata</a></li><li class="sidebar-sub-header"><a href="/back/distributed-transaction/Seata.html#实践" class="sidebar-link">实践</a></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Docker</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Utils</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="分布式事务解决框架-seata-springcloud-nacos"><a href="#分布式事务解决框架-seata-springcloud-nacos" class="header-anchor">#</a> 分布式事务解决框架 Seata + SpringCloud + Nacos</h1> <h2 id="一、搭建-seata-nacos"><a href="#一、搭建-seata-nacos" class="header-anchor">#</a> 一、搭建 Seata + Nacos</h2> <ol><li><p>从官网下载 Seata 的源码包和执行文件，由于文件都是在Github托管，可以从下面地址下载：<code>https://download.csdn.net/download/LarrYFinal/16515872</code></p></li> <li><p>修改配置文件  registry.conf、file.conf、conf.txt</p> <ol><li><p>修改registry.conf，使用的是Nacos作配置中心和注册中心</p> <div class="language- extra-class"><pre class="language-text"><code>registry {
  # file 、nacos 、eureka、redis、zk、consul、etcd3、sofa
  type = &quot;nacos&quot;
  loadBalance = &quot;RandomLoadBalance&quot;
  loadBalanceVirtualNodes = 10
  nacos {
    application = &quot;seata-server&quot;
    serverAddr = &quot;127.0.0.1:8848&quot;
    group = &quot;SEATA_GROUP&quot;
    namespace = &quot;public&quot;
    cluster = &quot;default&quot;
    username = &quot;nacos&quot;
    password = &quot;nacos&quot;
  }
}

config {
  # file、nacos 、apollo、zk、consul、etcd3
  type = &quot;nacos&quot;
  nacos {
    serverAddr = &quot;127.0.0.1:8848&quot;
    namespace = &quot;public&quot;
    group = &quot;SEATA_GROUP&quot;
    username = &quot;nacos&quot;
    password = &quot;nacos&quot;
  }
}
</code></pre></div></li> <li><p>修改 file.conf</p> <div class="language- extra-class"><pre class="language-text"><code>## transaction log store, only used in seata-server
store {
  ## store mode: file、db、redis
  mode = &quot;db&quot;
  ## database store property
  db {
    ## the implement of javax.sql.DataSource, such as DruidDataSource(druid)/BasicDataSource(dbcp)/HikariDataSource(hikari) etc.
    datasource = &quot;druid&quot;
    ## mysql/oracle/postgresql/h2/oceanbase etc.
    dbType = &quot;mysql&quot;
    driverClassName = &quot;com.mysql.cj.jdbc.Driver&quot;
    url = &quot;jdbc:mysql://127.0.0.1:3306/seata?characterEncoding=UTF8&amp;useSSL=false&amp;serverTimezone=Asia/Shanghai&quot;
    user = &quot;root&quot;
    password = &quot;123456&quot;
    minConn = 5
    maxConn = 100
    globalTable = &quot;global_table&quot;
    branchTable = &quot;branch_table&quot;
    lockTable = &quot;lock_table&quot;
    queryLimit = 100
    maxWait = 5000
  }
}
</code></pre></div></li> <li><p>修改config.txt (位于源码包中\seata-1.4.1-source\script\config-center\config.txt)</p> <div class="language- extra-class"><pre class="language-text"><code>service.vgroupMapping.my_test_tx_group=default
service.default.grouplist=127.0.0.1:8091
service.enableDegrade=false
service.disableGlobalTransaction=false
store.mode=db
store.db.datasource=druid 
store.db.dbType=mysql 
store.db.driverClassName=com.mysql.cj.jdbc.Driver
store.db.url=jdbc:mysql://127.0.0.1:3306/seata?characterEncoding=UTF8&amp;useSSL=false&amp;serverTimezone=Asia/Shanghai
store.db.user=root 
store.db.password=123456 
store.db.minConn=5 
store.db.maxConn=30 
store.db.globalTable=global_table 
store.db.branchTable=branch_table 
store.db.queryLimit=100 
store.db.lockTable=lock_table 
store.db.maxWait=5000
</code></pre></div></li></ol></li> <li><p>初始化数据库脚本（源码包中路径）</p> <ol><li><p>在路径<code>\seata-1.4.1-source\script\server\db\mysql.sql</code>,执行下面的脚本，记住是seata模式下</p> <div class="language- extra-class"><pre class="language-text"><code>-- -------------------------------- The script used when storeMode is 'db' --------------------------------
-- the table to store GlobalSession data
CREATE TABLE IF NOT EXISTS `global_table`
(
    `xid`                       VARCHAR(128) NOT NULL,
    `transaction_id`            BIGINT,
    `status`                    TINYINT      NOT NULL,
    `application_id`            VARCHAR(32),
    `transaction_service_group` VARCHAR(32),
    `transaction_name`          VARCHAR(128),
    `timeout`                   INT,
    `begin_time`                BIGINT,
    `application_data`          VARCHAR(2000),
    `gmt_create`                DATETIME,
    `gmt_modified`              DATETIME,
    PRIMARY KEY (`xid`),
    KEY `idx_gmt_modified_status` (`gmt_modified`, `status`),
    KEY `idx_transaction_id` (`transaction_id`)
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8;

-- the table to store BranchSession data
CREATE TABLE IF NOT EXISTS `branch_table`
(
    `branch_id`         BIGINT       NOT NULL,
    `xid`               VARCHAR(128) NOT NULL,
    `transaction_id`    BIGINT,
    `resource_group_id` VARCHAR(32),
    `resource_id`       VARCHAR(256),
    `branch_type`       VARCHAR(8),
    `status`            TINYINT,
    `client_id`         VARCHAR(64),
    `application_data`  VARCHAR(2000),
    `gmt_create`        DATETIME(6),
    `gmt_modified`      DATETIME(6),
    PRIMARY KEY (`branch_id`),
    KEY `idx_xid` (`xid`)
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8;

-- the table to store lock data
CREATE TABLE IF NOT EXISTS `lock_table`
(
    `row_key`        VARCHAR(128) NOT NULL,
    `xid`            VARCHAR(96),
    `transaction_id` BIGINT,
    `branch_id`      BIGINT       NOT NULL,
    `resource_id`    VARCHAR(256),
    `table_name`     VARCHAR(32),
    `pk`             VARCHAR(36),
    `gmt_create`     DATETIME,
    `gmt_modified`   DATETIME,
    PRIMARY KEY (`row_key`),
    KEY `idx_branch_id` (`branch_id`)
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8;
</code></pre></div></li> <li><p>在路径<code>\seata-1.4.1-source\script\client\at\db\mysql.sql</code>,初始化客户端SQL脚本，这里是 test模式下</p> <div class="language- extra-class"><pre class="language-text"><code>-- for AT mode you must to init this sql for you business database. the seata server not need it.
CREATE TABLE IF NOT EXISTS `undo_log`
(
    `branch_id`     BIGINT(20)   NOT NULL COMMENT 'branch transaction id',
    `xid`           VARCHAR(100) NOT NULL COMMENT 'global transaction id',
    `context`       VARCHAR(128) NOT NULL COMMENT 'undo_log context,such as serialization',
    `rollback_info` LONGBLOB     NOT NULL COMMENT 'rollback info',
    `log_status`    INT(11)      NOT NULL COMMENT '0:normal status,1:defense status',
    `log_created`   DATETIME(6)  NOT NULL COMMENT 'create datetime',
    `log_modified`  DATETIME(6)  NOT NULL COMMENT 'modify datetime',
    UNIQUE KEY `ux_undo_log` (`xid`, `branch_id`)
) ENGINE = InnoDB
  AUTO_INCREMENT = 1
  DEFAULT CHARSET = utf8 COMMENT ='AT transaction mode undo table';
</code></pre></div></li></ol></li> <li><p>上传配置到Nacos并启动Seata-Server</p> <ol><li><p>上传配置</p> <p>启动Nacos，然后在<code>\seata-1.4.1-source\script\config-center\nacos</code>路径下，执行<code>nacos-config.sh</code>，打开Git Bash，然后输入<code>sh nacos-config.sh</code></p> <p><img src="https://gitee.com/rule-liu/pic/raw/master/img/image-20210408222345416.png" alt="image-20210408222345416"></p> <p><img src="https://gitee.com/rule-liu/pic/raw/master/img/image-20210408222734149.png" alt="image-20210408222734149"></p></li> <li><p>启动Seata-Server，在下载好的直接运行的 Seata包中，路径为<code>D:\Software\seata\bin</code>，直接双击seata-server.bat.</p></li></ol></li></ol> <h2 id="spring-cloud-集成-seata"><a href="#spring-cloud-集成-seata" class="header-anchor">#</a> Spring Cloud 集成 Seata</h2> <ol><li><p>配置Spring Cloud 服务 application.yml</p> <ol><li><p>两个客户端，一个是消息生产者<code>nacos-service-provider</code>，一个是消息消费者<code>nacos-service-consumer</code>。分别配置它们的 application.yml</p></li> <li><p><code>nacos-service-provider</code> application.yml</p> <div class="language- extra-class"><pre class="language-text"><code>server:
  port: 8081
#Seata分布式事务配置(AT模式)
seata:
  enabled: true
  application-id: nacos-service-provider
  tx-service-group: my_test_tx_group
  config:
    type: nacos
    nacos:
      server-addr: 127.0.0.1:8848
      group: SEATA_GROUP
      username: &quot;&quot;
      password: &quot;&quot;
  registry:
    type: nacos
    nacos:
      application: seata-server
      server-addr: 127.0.0.1:8848
      group : &quot;SEATA_GROUP&quot;
      username: &quot;&quot;
      password: &quot;&quot;
</code></pre></div></li> <li><p><code>nacos-service-consumer</code> application.yml</p> <div class="language- extra-class"><pre class="language-text"><code>server:
  port: 8082
seata:
  enabled: true
  application-id: nacos-service-consumer
  tx-service-group: my_test_tx_group
  config:
    type: nacos
    nacos:
      server-addr: 127.0.0.1:8848
      group: SEATA_GROUP
      username: &quot;&quot;
      password: &quot;&quot;
  registry:
    type: nacos
    nacos:
      application: seata-server
      server-addr: 127.0.0.1:8848
      group : &quot;SEATA_GROUP&quot;
      username: &quot;&quot;
      password: &quot;&quot;
</code></pre></div></li></ol></li> <li><p>启动项目，此时在Nacos中有三个服务已经注册在上面</p> <p><img src="https://gitee.com/rule-liu/pic/raw/master/img/image-20210408223810756.png" alt="image-20210408223810756"></p></li></ol> <h2 id="实践"><a href="#实践" class="header-anchor">#</a> 实践</h2> <blockquote><p>前提：nacos-service-provider 发送消息告诉 nacos-service-consumer，增加用户信息。此时需要在 provider 端增加一条消息发送记录，然后再 consumer 端再增加一条用户信息。</p></blockquote> <h3 id="依赖文件"><a href="#依赖文件" class="header-anchor">#</a> 依赖文件</h3> <p>Provider、Consumer 都是一样</p> <div class="language- extra-class"><pre class="language-text"><code>依赖版本
&lt;dependencyManagement&gt;
    &lt;!--springcloud--&gt;
    &lt;dependencies&gt;
    &lt;dependency&gt;
    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-dependencies&lt;/artifactId&gt;
    &lt;version&gt;Hoxton.SR5&lt;/version&gt;
    &lt;type&gt;pom&lt;/type&gt;
    &lt;scope&gt;import&lt;/scope&gt;
    &lt;/dependency&gt;
    &lt;!--springcloud alibaba--&gt;
    &lt;dependency&gt;
    &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-alibaba-dependencies&lt;/artifactId&gt;
    &lt;version&gt;2.2.1.RELEASE&lt;/version&gt;
    &lt;type&gt;pom&lt;/type&gt;
    &lt;scope&gt;import&lt;/scope&gt;
    &lt;/dependency&gt;
    &lt;/dependencies&gt;
&lt;/dependencyManagement&gt;


&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
         xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;
    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;
    &lt;parent&gt;
        &lt;groupId&gt;com.rule.demo&lt;/groupId&gt;
        &lt;artifactId&gt;nacos-spring-cloud-demo&lt;/artifactId&gt;
        &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;
    &lt;/parent&gt;
    &lt;groupId&gt;com.rule&lt;/groupId&gt;
    &lt;artifactId&gt;nacos-service-consumer&lt;/artifactId&gt;
    &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;
    &lt;name&gt;nacos-service-consumer&lt;/name&gt;
    &lt;description&gt;Project for Spring Boot&lt;/description&gt;
    &lt;properties&gt;
        &lt;java.version&gt;1.8&lt;/java.version&gt;
    &lt;/properties&gt;
    &lt;dependencies&gt;
        &lt;!--seata--&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;io.seata&lt;/groupId&gt;
            &lt;artifactId&gt;seata-spring-boot-starter&lt;/artifactId&gt;
            &lt;version&gt;1.4.0&lt;/version&gt;
            &lt;exclusions&gt;
                &lt;exclusion&gt;
                    &lt;groupId&gt;com.alibaba&lt;/groupId&gt;
                    &lt;artifactId&gt;druid&lt;/artifactId&gt;
                &lt;/exclusion&gt;
            &lt;/exclusions&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;
            &lt;artifactId&gt;spring-cloud-starter-alibaba-seata&lt;/artifactId&gt;
            &lt;exclusions&gt;
                &lt;exclusion&gt;
                    &lt;groupId&gt;io.seata&lt;/groupId&gt;
                    &lt;artifactId&gt;seata-spring-boot-starter&lt;/artifactId&gt;
                &lt;/exclusion&gt;
            &lt;/exclusions&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;!--mysql--&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;mysql&lt;/groupId&gt;
            &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;
            &lt;version&gt;8.0.13&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;!--mybatis-plus--&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.baomidou&lt;/groupId&gt;
            &lt;artifactId&gt;mybatis-plus&lt;/artifactId&gt;
            &lt;version&gt;3.4.2&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.baomidou&lt;/groupId&gt;
            &lt;artifactId&gt;mybatis-plus-boot-starter&lt;/artifactId&gt;
            &lt;version&gt;3.0.5&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.mybatis.spring.boot&lt;/groupId&gt;
            &lt;artifactId&gt;mybatis-spring-boot-starter&lt;/artifactId&gt;
            &lt;version&gt;2.1.3&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;!-- 引入Druid依赖，阿里巴巴所提供的数据源 --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.alibaba&lt;/groupId&gt;
            &lt;artifactId&gt;druid&lt;/artifactId&gt;
            &lt;version&gt;1.1.10&lt;/version&gt;
        &lt;/dependency&gt;

        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;

    &lt;build&gt;
        &lt;plugins&gt;
            &lt;plugin&gt;
                &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
                &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;
            &lt;/plugin&gt;
        &lt;/plugins&gt;
    &lt;/build&gt;

&lt;/project&gt;
</code></pre></div><h3 id="实现-provider-端"><a href="#实现-provider-端" class="header-anchor">#</a> 实现 provider 端</h3> <p>​	主要是三个文件  UserClient、MessageInfo、MessageController、MessageMapper</p> <p>​	<img src="https://gitee.com/rule-liu/pic/raw/master/img/image-20210408225202674.png" alt="image-20210408225202674"></p> <ol><li><p>UserClient</p> <div class="language- extra-class"><pre class="language-text"><code>/**
 * 修改用户名接口
 */
@FeignClient(&quot;nacos-service-consumer&quot;)
public interface UserClient {

    @PostMapping(&quot;/user&quot;)
    void updateUserInfo(@RequestParam(&quot;id&quot;) String id,
                        @RequestParam(&quot;username&quot;) String username);

}
</code></pre></div></li> <li><p>MessageInfo</p> <div class="language- extra-class"><pre class="language-text"><code>@Getter
@Setter
@TableName(value = &quot;t_message&quot;)
@Builder
public class MessageInfo {

    /**
     * id
     */
    @TableId(value = &quot;id&quot;, type = IdType.AUTO)
    private Integer id;

    /**
     * 标题
     */
    private String title;

    /**
     * 请求内容
     */
    private String body;

    /**
     * 类型
     */
    private String type;

}
</code></pre></div></li> <li><p>MessageController</p> <div class="language- extra-class"><pre class="language-text"><code>/**
 * 生产者服务，测试seata
 */
@RestController
@RequestMapping(&quot;/provider&quot;)
public class MessageController {

    @Resource
    private MessageMapper messageMapper;

    @Autowired
    private UserClient userClient;

    /**
     * 发送消息修改用户信息
     */
    @GetMapping(&quot;/send&quot;)
    // @GlobalTransactional  配置全局的事务方案
//    @GlobalTransactional 
    public void sendMessage() {
        // 添加消息
        MessageInfo messageInfo = MessageInfo.builder().title(&quot;update user username&quot;)
                .body(&quot;{\&quot;id\&quot;:\&quot;1\&quot;, \&quot;username\&quot;:\&quot;jarry\&quot;}&quot;)
                .type(&quot;send&quot;).build();

        messageMapper.insert(messageInfo);
        JSONObject body = JSON.parseObject(messageInfo.getBody());
        // 调用userClient 增加用户信息
        String username = body.getString(&quot;username&quot;) + System.currentTimeMillis();
        userClient.updateUserInfo(body.getString(&quot;id&quot;), username);
        throw new RuntimeException(&quot;修改失败&quot;);
    }
}
</code></pre></div></li> <li><p>MessageMapper</p> <div class="language- extra-class"><pre class="language-text"><code>@Mapper
public interface MessageMapper extends BaseMapper&lt;MessageInfo&gt; {
}
</code></pre></div></li></ol> <h3 id="实现-consumer-端"><a href="#实现-consumer-端" class="header-anchor">#</a> 实现 consumer 端</h3> <p>​	主要是三个文件  UserInfo、UserController、UserMapper</p> <p>​	<img src="https://gitee.com/rule-liu/pic/raw/master/img/image-20210408225234940.png" alt="image-20210408225234940"></p> <ol><li><p>UserInfo</p> <div class="language- extra-class"><pre class="language-text"><code>@Data
@TableName(value = &quot;t_user&quot;)
@Builder
public class UserInfo {

    @TableId(value = &quot;ID&quot;, type = IdType.AUTO)
    private Integer id;

    /**
     * 用户名
     */
    private String username;

    /**
     * 密码
     */
    private String password;

    /**
     * 权限
     */
    private String authorities;

}
</code></pre></div></li> <li><p>UserController</p> <div class="language- extra-class"><pre class="language-text"><code>@RestController
@RequestMapping(&quot;/user&quot;)
public class UserController {


    @Resource
    private UserMapper userMapper;

    @PostMapping
    public void updateUserInfo(@RequestParam(&quot;id&quot;) String id,
                               @RequestParam(&quot;username&quot;) String username) {

        // 增加一条用户信息
        UserInfo userInfo = UserInfo.builder().username(username).password(&quot;123456&quot;).authorities(&quot;123&quot;).build();
        userMapper.insert(userInfo);
    }
}
</code></pre></div></li> <li><p>UserMapper</p> <div class="language- extra-class"><pre class="language-text"><code>@Mapper
public interface UserMapper extends BaseMapper&lt;UserInfo&gt; {
}
</code></pre></div></li> <li><p>模拟正常的逻辑下，出现分布式事务</p> <ol><li><p>分别在两个客户端的控制层加上 <code>@Transactional</code>注解。模拟出现运行时异常时，让两者都不增加数据，结果却是 t_message没有增加，但是 t_user 增加一条用户</p> <div class="language- extra-class"><pre class="language-text"><code>    @GetMapping(&quot;/send&quot;)
    @Transactional
    public void sendMessage() {
        ``````
        ``````
        throw new RuntimeException(&quot;修改失败&quot;);
    }
    
        @PostMapping
    @Transactional
    public void updateUserInfo(@RequestParam(&quot;id&quot;) String id,
                               @RequestParam(&quot;username&quot;) String username) {
        // 增加一条用户信息
        UserInfo userInfo = UserInfo.builder().username(username).password(&quot;123456&quot;).authorities(&quot;123&quot;).build();
        userMapper.insert(userInfo);
    }
</code></pre></div></li> <li><p>模拟请求，查看结果</p> <p><img src="https://gitee.com/rule-liu/pic/raw/master/img/image-20210408225834979.png" alt="image-20210408225834979"></p> <p><img src="https://gitee.com/rule-liu/pic/raw/master/img/image-20210408230036386.png" alt="image-20210408230036386"></p></li></ol></li> <li><p>模拟使用 Seata，解决分布式事务</p> <ol><li><p>只需要在 MessageController 上增加 <code>@GlobalTransactional</code> 注解。清空下两个表，再次模拟出现运行时异常时，结果时两者都没有增加数据。</p> <div class="language- extra-class"><pre class="language-text"><code>@GetMapping(&quot;/send&quot;)
    // @GlobalTransactional  配置全局的事务方案
    @GlobalTransactional
    public void sendMessage() {
		````
		````
		throw new RuntimeException(&quot;修改失败&quot;);
    }
</code></pre></div></li> <li><p>模拟请求，查看结果</p> <p><img src="https://gitee.com/rule-liu/pic/raw/master/img/image-20210408230601241.png" alt="image-20210408230601241"></p></li></ol></li></ol></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">2021/4/15 下午8:25:31</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/back/distributed-transaction/Transaction.html" class="prev">
        分布式事务原理及解决方案
      </a></span> <span class="next"><a href="/back/docker/install.html">
        安装docker
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.eb78e4ff.js" defer></script><script src="/assets/js/2.062734e7.js" defer></script><script src="/assets/js/17.0fce2c50.js" defer></script>
  </body>
</html>
