<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>垃圾回收机制 | RuleLau&#39;s Blog</title>
    <meta name="generator" content="VuePress 1.7.1">
    <link rel="icon" href="/icon.jpg">
    <meta name="description" content="我的个人网站">
    
    <link rel="preload" href="/assets/css/0.styles.99ba71c7.css" as="style"><link rel="preload" href="/assets/js/app.eb78e4ff.js" as="script"><link rel="preload" href="/assets/js/2.062734e7.js" as="script"><link rel="preload" href="/assets/js/30.14b54e61.js" as="script"><link rel="prefetch" href="/assets/js/10.1fa9c2ce.js"><link rel="prefetch" href="/assets/js/11.b67db8c9.js"><link rel="prefetch" href="/assets/js/12.41340d35.js"><link rel="prefetch" href="/assets/js/13.f7873189.js"><link rel="prefetch" href="/assets/js/14.3a7cc814.js"><link rel="prefetch" href="/assets/js/15.7c3e8bd4.js"><link rel="prefetch" href="/assets/js/16.4d3c2513.js"><link rel="prefetch" href="/assets/js/17.0fce2c50.js"><link rel="prefetch" href="/assets/js/18.0fee2fc2.js"><link rel="prefetch" href="/assets/js/19.cd739ab0.js"><link rel="prefetch" href="/assets/js/20.ccee1235.js"><link rel="prefetch" href="/assets/js/21.3b3ad479.js"><link rel="prefetch" href="/assets/js/22.1a0c7439.js"><link rel="prefetch" href="/assets/js/23.e1875da8.js"><link rel="prefetch" href="/assets/js/24.5428519d.js"><link rel="prefetch" href="/assets/js/25.4be82a8e.js"><link rel="prefetch" href="/assets/js/26.ee5c4ae0.js"><link rel="prefetch" href="/assets/js/27.6f1bb712.js"><link rel="prefetch" href="/assets/js/28.668b830a.js"><link rel="prefetch" href="/assets/js/29.e001ee62.js"><link rel="prefetch" href="/assets/js/3.7c25579e.js"><link rel="prefetch" href="/assets/js/31.8c7b7656.js"><link rel="prefetch" href="/assets/js/32.7895a749.js"><link rel="prefetch" href="/assets/js/33.7fdc13eb.js"><link rel="prefetch" href="/assets/js/34.497597fd.js"><link rel="prefetch" href="/assets/js/35.e45ce9de.js"><link rel="prefetch" href="/assets/js/36.dff9db21.js"><link rel="prefetch" href="/assets/js/37.84dca43f.js"><link rel="prefetch" href="/assets/js/38.d35b0106.js"><link rel="prefetch" href="/assets/js/39.cdb3310a.js"><link rel="prefetch" href="/assets/js/4.23425003.js"><link rel="prefetch" href="/assets/js/40.09ef43de.js"><link rel="prefetch" href="/assets/js/41.611a6d59.js"><link rel="prefetch" href="/assets/js/42.67cf3e85.js"><link rel="prefetch" href="/assets/js/43.6327f0de.js"><link rel="prefetch" href="/assets/js/5.cb6c276b.js"><link rel="prefetch" href="/assets/js/6.8acca1fd.js"><link rel="prefetch" href="/assets/js/7.fca05378.js"><link rel="prefetch" href="/assets/js/8.1f37df4a.js"><link rel="prefetch" href="/assets/js/9.f5dc1ff5.js">
    <link rel="stylesheet" href="/assets/css/0.styles.99ba71c7.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/icon.jpg" alt="RuleLau's Blog" class="logo"> <span class="site-name can-hide">RuleLau's Blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/back/" class="nav-link router-link-active">
  后端
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/back/" class="nav-link router-link-active">
  后端
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>JVM</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/back/jvm/JMM.html" class="sidebar-link">JVM内存结构</a></li><li><a href="/back/jvm/JVMStructure.html" class="sidebar-link">对象的内存布局</a></li><li><a href="/back/jvm/GCAlgorithm.html" class="sidebar-link">垃圾收集策略与算法</a></li><li><a href="/back/jvm/GC.html" class="sidebar-link">垃圾收集器</a></li><li><a href="/back/jvm/MemoryAllocation.html" class="sidebar-link">内存分配与回收策略</a></li><li><a href="/back/jvm/ClassStructure.html" class="sidebar-link">类文件结构</a></li><li><a href="/back/jvm/ClassLoader.html" class="sidebar-link">类加载</a></li><li><a href="/back/jvm/CMS、G1 垃圾收集器中的标记原理.html" class="sidebar-link">CMS、G1 垃圾收集器中的标记原理</a></li><li><a href="/back/jvm/jvm问题.html" class="sidebar-link">jvm 知识点</a></li><li><a href="/back/jvm/垃圾回收机制.html" class="active sidebar-link">垃圾回收机制</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/back/jvm/垃圾回收机制.html#垃圾回收机制" class="sidebar-link">垃圾回收机制</a></li><li class="sidebar-sub-header"><a href="/back/jvm/垃圾回收机制.html#新生代分配机制" class="sidebar-link">新生代分配机制</a></li><li class="sidebar-sub-header"><a href="/back/jvm/垃圾回收机制.html#新生代-复制算法" class="sidebar-link">新生代（复制算法）</a></li><li class="sidebar-sub-header"><a href="/back/jvm/垃圾回收机制.html#老年代-标记整理" class="sidebar-link">老年代（标记整理）</a></li><li class="sidebar-sub-header"><a href="/back/jvm/垃圾回收机制.html#新生代进入老年代条件" class="sidebar-link">新生代进入老年代条件</a></li><li class="sidebar-sub-header"><a href="/back/jvm/垃圾回收机制.html#触发full-gc-条件" class="sidebar-link">触发Full GC 条件</a></li><li class="sidebar-sub-header"><a href="/back/jvm/垃圾回收机制.html#concurrent-mode-failure-触发条件" class="sidebar-link">Concurrent Mode Failure 触发条件</a></li></ul></li><li><a href="/back/jvm/垃圾收集器.html" class="sidebar-link">垃圾收集器过程</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Concurrency</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>ThreadPool</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Redis</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>SpringCloud</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Design Pattern</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Distributed-Transaction</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Docker</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Utils</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="垃圾回收机制"><a href="#垃圾回收机制" class="header-anchor">#</a> 垃圾回收机制</h2> <h2 id="新生代分配机制"><a href="#新生代分配机制" class="header-anchor">#</a> 新生代分配机制</h2> <h3 id="新对象优先存入eden区"><a href="#新对象优先存入eden区" class="header-anchor">#</a> 新对象优先存入Eden区</h3> <ul><li><p>Minor GC 触发条件</p> <ul><li>Eden 区满时，触发一次MinorGC</li> <li>Full GC之前调用</li></ul></li></ul> <h2 id="新生代-复制算法"><a href="#新生代-复制算法" class="header-anchor">#</a> 新生代（复制算法）</h2> <h3 id="当eden区满时-触发minor-gc-将eden区中存活对象一次性转移到空的survivor1-中-那么表示eden-区已经清空了-可以再次进行分配。而survivor1-中则存放的是上一次的minor-gc后存活的对象-如果下次eden-区-满-则再次触发minor-gc-将eden区和上一次minorgc-后存活对象的survivor1-区内的存活对象转移到-survivor2-区中-反复如此。"><a href="#当eden区满时-触发minor-gc-将eden区中存活对象一次性转移到空的survivor1-中-那么表示eden-区已经清空了-可以再次进行分配。而survivor1-中则存放的是上一次的minor-gc后存活的对象-如果下次eden-区-满-则再次触发minor-gc-将eden区和上一次minorgc-后存活对象的survivor1-区内的存活对象转移到-survivor2-区中-反复如此。" class="header-anchor">#</a> 当Eden区满时，触发Minor GC，将Eden区中存活对象一次性转移到空的Survivor1 中，那么表示Eden 区已经清空了，可以再次进行分配。而Survivor1 中则存放的是上一次的Minor GC后存活的对象，如果下次Eden 区 满，则再次触发Minor GC，将Eden区和上一次MinorGC 后存活对象的Survivor1 区内的存活对象转移到 Survivor2 区中，反复如此。</h3> <h2 id="老年代-标记整理"><a href="#老年代-标记整理" class="header-anchor">#</a> 老年代（标记整理）</h2> <h3 id="将老年代中标记的存活对象在内存中移动-让存活对象紧凑靠在一起-然后继续垃圾回收-这样避免了垃圾回收后的带来的过多的内存碎片。先整理后清除。"><a href="#将老年代中标记的存活对象在内存中移动-让存活对象紧凑靠在一起-然后继续垃圾回收-这样避免了垃圾回收后的带来的过多的内存碎片。先整理后清除。" class="header-anchor">#</a> 将老年代中标记的存活对象在内存中移动，让存活对象紧凑靠在一起，然后继续垃圾回收，这样避免了垃圾回收后的带来的过多的内存碎片。先整理后清除。</h3> <h2 id="新生代进入老年代条件"><a href="#新生代进入老年代条件" class="header-anchor">#</a> 新生代进入老年代条件</h2> <h3 id="大对象直接进入老年代-根据参数-xx-pretenuresizethreshold-决定-不会进入新生代"><a href="#大对象直接进入老年代-根据参数-xx-pretenuresizethreshold-决定-不会进入新生代" class="header-anchor">#</a> 大对象直接进入老年代，根据参数 -XX:PretenureSizeThreshold 决定，不会进入新生代</h3> <h3 id="在默认设置下-当对象的年龄达到15岁时-转移到老年代。可以通过设置-xx-maxtenuringthreshold-年龄阈值-默认为15"><a href="#在默认设置下-当对象的年龄达到15岁时-转移到老年代。可以通过设置-xx-maxtenuringthreshold-年龄阈值-默认为15" class="header-anchor">#</a> 在默认设置下，当对象的年龄达到15岁时，转移到老年代。可以通过设置-XX:MaxTenuringThreshold 年龄阈值，默认为15</h3> <h3 id="动态年龄-新生代中所有对象的年龄根据规则-年龄1-年龄2-年龄n超过-survivor-区中的50-那么年龄n及以上的对象会放入老年代。"><a href="#动态年龄-新生代中所有对象的年龄根据规则-年龄1-年龄2-年龄n超过-survivor-区中的50-那么年龄n及以上的对象会放入老年代。" class="header-anchor">#</a> 动态年龄：新生代中所有对象的年龄根据规则：年龄1+年龄2+..+年龄n超过 survivor 区中的50%, 那么年龄n及以上的对象会放入老年代。</h3> <h3 id="minor-gc前都会检查新生代全部对象是否小于老年代可用内存大小"><a href="#minor-gc前都会检查新生代全部对象是否小于老年代可用内存大小" class="header-anchor">#</a> Minor GC前都会检查新生代全部对象是否小于老年代可用内存大小</h3> <ul><li><p>如果检查后，老年代容量足够前提下，那么进行 Minor GC，然后将最后存活的这些对象放入老年代</p></li> <li><p>如果新生代所有对象大于老年代可用内存，表示老年代容量不足时，查看参数-XX:-
HandlePromotionFailure ，是否设置了担保失败配置，1.6后默认时开启。</p> <ul><li><p>设置了该参数，判断老年代的内存大小，大于之前每一次Minor GC 后进入老年代对象的平均大小。</p> <ul><li>如果大于，那么执行Minor GC，执行过后，根据动态年龄规则，将符合规则的存活对象进入Survivor区</li> <li>剩余存活对象大于Survivor 区的一半，但小于老年代可用内存，那么剩余对象直接进入老年代</li> <li>剩余对象都大于Survivor、老年代可用内存大小，发生Handle Promotion Failure 担保失败情况，执行Full GC，然后再进行Minor GC，</li></ul></li> <li><p>设置了该参数，如果小于，那么执行Full GC, 然后再执行Minor GC</p> <ul><li>Minor GC后，老年代还是没有足够的空间存放Minor GC过后的剩余对象，那么就会导致OOM内存溢出。</li></ul></li> <li><p>没有设置该参数，执行 Full GC，腾出一些内存空间，然后再执行Minor GC</p></li></ul></li></ul> <h2 id="触发full-gc-条件"><a href="#触发full-gc-条件" class="header-anchor">#</a> 触发Full GC 条件</h2> <h3 id="当老年代中存活对象达到老年代一定的比例时-则会触发full-gc。参数为cmsinitiatingoccupancyfaction-默认比例为92"><a href="#当老年代中存活对象达到老年代一定的比例时-则会触发full-gc。参数为cmsinitiatingoccupancyfaction-默认比例为92" class="header-anchor">#</a> 当老年代中存活对象达到老年代一定的比例时，则会触发Full GC。参数为CMSInitiatingOccupancyFaction，默认比例为92%</h3> <h3 id="minor-gc后-新生代对象大于survivor-区、老年代可用内存并且每次进入老年代的平均内存大于老年代可用内存"><a href="#minor-gc后-新生代对象大于survivor-区、老年代可用内存并且每次进入老年代的平均内存大于老年代可用内存" class="header-anchor">#</a> Minor GC后，新生代对象大于Survivor 区、老年代可用内存并且每次进入老年代的平均内存大于老年代可用内存</h3> <h2 id="concurrent-mode-failure-触发条件"><a href="#concurrent-mode-failure-触发条件" class="header-anchor">#</a> Concurrent Mode Failure 触发条件</h2> <h3 id="cms-并发清理清理阶段-cms-只不过回收之前标记好的垃圾对象-应用线程会一直进行-可能会进行minor-gc-那么从年轻代晋升的新的对象-有可能直接放入老年代-这时候-老年代也放不下-就会导致-concurrent-mode-failure-问题。这时-老年代中可能也会存在没人引用的对象-那么这个就是-浮动垃圾-。然后cms会自动降级-使用-serial-old-垃圾回收器-强行系统stw-重新进行标记-清理。当上次minor-gc-再次full-gc-时-则会将当前的full-gc-停止-先将正在执行的full-gc-执行完。"><a href="#cms-并发清理清理阶段-cms-只不过回收之前标记好的垃圾对象-应用线程会一直进行-可能会进行minor-gc-那么从年轻代晋升的新的对象-有可能直接放入老年代-这时候-老年代也放不下-就会导致-concurrent-mode-failure-问题。这时-老年代中可能也会存在没人引用的对象-那么这个就是-浮动垃圾-。然后cms会自动降级-使用-serial-old-垃圾回收器-强行系统stw-重新进行标记-清理。当上次minor-gc-再次full-gc-时-则会将当前的full-gc-停止-先将正在执行的full-gc-执行完。" class="header-anchor">#</a> CMS 并发清理清理阶段，CMS 只不过回收之前标记好的垃圾对象，应用线程会一直进行，可能会进行Minor GC, 那么从年轻代晋升的新的对象，有可能直接放入老年代，这时候，老年代也放不下，就会导致  Concurrent Mode Failure 问题。这时，老年代中可能也会存在没人引用的对象，那么这个就是“浮动垃圾”。然后CMS会自动降级，使用&quot;Serial Old&quot;垃圾回收器，强行系统STW，重新进行标记，清理。当上次Minor GC 再次Full GC 时，则会将当前的Full GC 停止，先将正在执行的Full GC 执行完。</h3></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/back/jvm/jvm问题.html" class="prev">
        jvm 知识点
      </a></span> <span class="next"><a href="/back/jvm/垃圾收集器.html">
        垃圾收集器过程
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.eb78e4ff.js" defer></script><script src="/assets/js/2.062734e7.js" defer></script><script src="/assets/js/30.14b54e61.js" defer></script>
  </body>
</html>
